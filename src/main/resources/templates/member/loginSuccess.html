<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>로그인 성공</title>

    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>

    <link rel="stylesheet" type="text/css" th:href="@{/css/main/reset.css}"/>
</head>
<body>
<!-- S: header -->
    <div class="header">
        <div class="user_area">
            <h3 style="text-align: center"><span style="text-align: center;" th:text="${ #authentication.getPrincipal().getNickname()}"></span>님의 방문을 환영합니다!!</h3>
        </div>
        <div class="logout_area" style="text-align: center">
            <button onclick="location.href='/member/logout'">로그아웃</button>
        </div>
    </div>
<!-- E: header -->

<!-- S: container -->
    <div class="container">
        <label for="content">댓글 개수 : <span th:text="${ totalCount }"></span></label>
        <form name="commentInsertForm">
            <div class="input-group">
                <input type="hidden" name="writer" th:value="${ #authentication.getPrincipal().getNickname() }">
                <input type="text" class="form-control" id="content" name="content" placeholder="내용을 입력해주세요.">
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" name="commentInsertBtn">등록</button>
                </span>
            </div>
        </form>
    </div>

    <div class="container">
        <div class="commentList">
            <table id="commentTable">
                <thead>
                    <tr>
                        <th>댓글 내용</th>
                        <th>작성자</th>
                        <th>작성일</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

<!-- E: container -->

<script>
$('[name=commentInsertBtn]').click(function(){ // 댓글 등록 버튼 클릭시

    let insertData = $('[name=commentInsertForm]').serialize(); // commentInsertForm의 내용을 가져옴
    commentInsert(insertData);
});

// 댓글 리스트
function commentList(){

    $.ajax({
        url : "/member/commentList",
        type : "GET",
        contentType : 'application/json',

        success : function(data){

            let commentList = JSON.parse(data);
            console.log(commentList);

            let $table = $("#commentTable tbody");
            $table.html("");

            for(let idx in commentList){

                let $tr = $("<tr>");
                let $content = $('<td>').text(commentList[idx].content);
                let $writer = $('<td>').text(commentList[idx].writer);
                let $regDate = $('<td>').text(commentList[idx].regDate);

                $tr.append($content);
                $tr.append($writer);
                $tr.append($regDate);

                $table.append($tr);

            }
        },
        error : function(){

            alert('오류!')
        }

    });
}

// 댓글 등록
function commentInsert(insertData) {
    $.ajax({
        url: '/member/commentInsert',
        type: 'POST',
        data: insertData,

        success: function(data) {
            if (data == 1) {
                commentList();
                $('[name=content]').val(''); // 댓글 등록 성공시 foam 내용 초기화
            }
        },

        error: function(error){
            console.log(error);
        }
    });
}

$(document).ready(function(){
   commentList(); // 페이지 로딩시 댓글 목록 출력
});

</script>
</body>
</html>